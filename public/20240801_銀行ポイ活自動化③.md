---
title: '銀行ポイ活自動化でひと月1,000円稼ぐ方法③'
tags:
  - AWS
  - Docker
  - lambda
  - ECR
  - 銀行振込
private: true
updated_at: '2024-08-06T22:14:57+09:00'
id: 3ab851723c22b626be00
organization_url_name: null
slide: false
ignorePublish: false
---
## はじめに

↓ の記事の続きとなります。

https://qiita.com/yr260625_learning/private/7e9d011d02bf8d3d98ab

https://qiita.com/yr260625_learning/private/7dbfabe8eed4d6ff9d3f

本記事では、以下の内容について記載します。
* Amazon ECR に Docker イメージを push する
* Docker イメージを用いて AWS Lambda の関数を作成する
* Amazon EventBridge で定期実行の設定を行う

## 構成図

![銀行ポイ活自動化③_AWS構成図.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/48efa8eb-416e-64a6-bf8c-59c708e1d691.png)

## Amazon ECR

### Amazon ECR とは

Docker のイメージを保存することができるサービスです。保存したイメージを用いて AWS Lamnda の関数を作成することが可能となります。他にも ECS, Fargate などのサービスでも使いまわすことができます。

### リポジトリの作成

リポジトリを作成する手順を記載します。リージョンはあらかじめ適切な位置を選択しておけばよいです。自分は大阪リージョンを選択します。

「作成」ボタンを押下します。

![銀行ポイ活自動化③_ECR_1.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/b93b989e-8f6f-36eb-377a-d5355d839929.png)

リポジトリ名を入力して「リポジトリを作成」ボタンを押下します。

![銀行ポイ活自動化③_ECR_2.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/c619b0cb-e17b-b10c-319b-6764f886d861.png)

これでリポジトリの追加が完了です。一覧の2行目に追加したリポジトリが表示されています。

![銀行ポイ活自動化③_ECR_3.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/aba9e16b-6a75-f494-ff20-92e464f3dad9.png)

### イメージをpush

AWS CLI が必要になるのでインストールします。インストール手順は以下のページにあります。

https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/getting-started-install.html

インストール完了後、AWSのリソースにアクセスするための認証情報を設定します。手順は以下のページにあります。

https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-authentication-user.html

上記の設定を完了後、環境変数に適切な値を設定して以下のシェルを実行します。これでイメージビルド ～ push の一連の作業を行います。

```bash
#!/bin/bash

# 環境変数読み込み
. .env

# ECRにログイン
aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ECR_URI}

# Dockerイメージ作成
docker build -t ${IMAGE_NAME} .

# Dockerイメージにタグ付け
docker tag ${IMAGE_NAME}:latest ${ECR_URI}/${ECR_REPOSITORY}:latest

# リポジトリにpush
docker push ${ECR_URI}/${ECR_REPOSITORY}:latest
```

実行結果は以下の通りです。

![銀行ポイ活自動化③_ECR_4.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/13143da5-dadf-e4d4-eed7-30626062a0ac.png)

latest のタグを付けられたイメージが一つ追加されたことを、 AWS のコンソール上で確認できます。

![銀行ポイ活自動化③_ECR_5.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/aca483cc-1ef9-8ead-57f7-c5c235532446.png)


## AWS Lambda

### AWS Lambda とは



### 関数の作成

関数を作成する手順を記載します。リージョンはあらかじめ適切な位置を選択しておけばよいです。自分は大阪リージョンを選択します。

「関数の作成」ボタンを押下します。

![銀行ポイ活自動化③_Lambda_1.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/f0acb406-a4e2-4dce-b5ee-81e7ae81d7dd.png)

「コンテナイメージ」を選択して、必要な情報を入力します。コンテナイメージURI は、先ほど作成したECR のイメージのURIを入力します。(「イメージを参照」から簡単に選択できます。)

![銀行ポイ活自動化③_Lambda_2.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/3a3a2363-ad94-6785-21bc-dc78e5796241.png)

このような画面が表示されれば作成完了です。

![銀行ポイ活自動化③_Lambda_3.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/b82b1f28-08be-378a-d247-b4cb3fbe456b.png)

### 関数の設定

設定タブの「一般設定」で、メモリとタイムアウトをデフォルト値から変更しておきます。今回は、メモリを512MB、タイムアウト値を2分とします。

![銀行ポイ活自動化③_Lambda_4.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/a2b33cdb-ce2a-56d9-0ed2-e523fa665310.png)

![銀行ポイ活自動化③_Lambda_5.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/74458e32-70f6-9f05-36f5-3595cf6126f4.png)

![銀行ポイ活自動化③_Lambda_6.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/a2518c7a-c6f4-a7f8-2080-65c5d2de3684.png)

次に設定タブの「環境変数」タブで必要な環境変数を設定します。

![銀行ポイ活自動化③_Lambda_7.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/44d847e4-3196-8d66-0654-1cf87330093b.png)

![銀行ポイ活自動化③_Lambda_8.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/91f118ac-2e48-42a1-51c4-77fc34e2a922.png)

![銀行ポイ活自動化③_Lambda_9.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/72e6fb6f-34b0-2bce-15e1-338ed901956d.png)


### 実行

ここまでの手順で実行する準備が整いました。手動で実行してみます。テストタブから「テスト」ボタンで実行してみます。

![銀行ポイ活自動化③_Lambda_10.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/38913c32-a079-b876-b25d-1e6a9ab672b7.png)

実行結果はこのようになりました。問題なく動いていることが分かります。

![銀行ポイ活自動化③_Lambda_11.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/77939eed-5d40-2751-632e-9ae6537cf82b.png)

## Amazon EventBridge

最後に定期実行させる設定を行います。ひと月25回実行させたいので、1日~25日の間、21:00に実行させるようにします。


Lambda の関数のトップにある「トリガーを追加」ボタンを押下します。

![銀行ポイ活自動化③_Lambda_12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/76b0c622-a4db-08a1-dc64-f69d1a83ee28.png)

EventBridge を選択して、以下の cron 式を入力します。

```bash
# 分 時間 日 月 曜日 年の順に指定する。
cron(0 12 1-25 * ? *)
```

12 時を指定しているように見えますが、これで日本時間の 21 時に実行されます。EventBridge は協定世界時(UTC)を基準にしているため、日本標準時(JST)に換算するために +9 しないといけないようです。

![銀行ポイ活自動化③_Lambda_13.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/9216014a-5eee-1c47-0f81-1c3fe4c61882.png)


## おわりに

銀行振込をひと月25回行う自動で行う準備ができました。後は放置しておくだけで、毎月1,000円GETすることができます。ここまでで割と満足できましたが、次が最後です。アプリの改修を行ったときに、AWS に自動デプロイできるようにします。Github Actions を使用することを検討しています。
