---
title: '銀行ポイ活自動化でひと月1,000円稼ぐ方法②'
tags:
  - AWS
  - Docker
  - 銀行振込
private: true
updated_at: '2024-07-31T22:02:12+09:00'
id: 7dbfabe8eed4d6ff9d3f
organization_url_name: null
slide: false
ignorePublish: false
---
## はじめに

↓の記事の続きとなります。

https://qiita.com/yr260625_learning/private/7e9d011d02bf8d3d98ab

本記事では、以下の内容について記載します。
* Dockerを使用して、以前に作成したPythonアプリをコンテナ化する
* DockerイメージをAWS ECRにプッシュしてデプロイするための準備を行う

## 経緯

実はDockerを使用するつもりは当初は無かったです。以下のような手順だけでいけると思っていたからです。

1. AWS Lambdaの関数を作成してコードをアップする
2. Lambdaレイヤーに必要なパッケージをアップする

  * python
  * chromium
  * headless-chromium

3. Amazon EventBridgeの設定で定期実行

しかしこの手順ではうまくいきませんでした。以下に失敗したときの手順を記載します。

<details><summary>失敗例</summary>

### Lambda関数作成

まずは単純な例としてドライバーを生成するだけして終了する関数を作成しました。

![銀行ポイ活自動化②_Lambda関数.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/00b64b4f-5708-d9ae-b301-51c60923be94.png)

```python
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service

def lambda_handler(event, context):
    options = Options()
    options.add_argument("--headless")
    options.add_argument("--disable-gpu")
    options.add_argument("--single-process")
    options.add_argument("--ignore-certificate-errors")
    options.add_argument("--no-sandbox")
    browser = webdriver.Chrome(
        service=Service("/opt/headless/chromedriver"),
        options=options
    )
    return 0
```

### パッケージ作成

ターミナルから以下のコマンドを実行してzipの作成します。

```bash
# pyenv導入
git clone https://github.com/pyenv/pyenv.git ~/.pyenv
echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.bash_profile
echo 'eval "$(pyenv init -)"' >> ~/.bash_profile
source ~/.bash_profile

# python3.10に切替
pyenv install 3.10.3
pyenv global 3.10.3

# pythonパッケージ準備
mkdir python
cd python
pip install --upgrade pip
pip install selenium==4.22.0 -t .
cd ../
zip -r python python

# chromium
mkdir headless
cd headless
curl -SL https://github.com/adieuadieu/serverless-chrome/releases/download/v1.0.0-55/stable-headless-chromium-amazonlinux-2017-03.zip > headless-chromium.zip
unzip -o headless-chromium.zip -d .
rm headless-chromium.zip
curl -SL https://chromedriver.storage.googleapis.com/2.43/chromedriver_linux64.zip > chromedriver.zip
unzip -o chromedriver.zip -d .
rm chromedriver.zip
cd ../
zip -r headless headless
```

出来上がった`python.zip`と`headless.zip`を使用してLambdaレイヤーを作成します。こちらの画面で必要な情報を入力して、作成ボタンを押下すればよいです。

![銀行ポイ活自動化②_Lambdaレイヤー.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/537a8781-b170-2abe-c330-755caa0294a9.png)

### 実行結果(失敗する) 

Lambda関数を実行すると以下の結果が返ってきました。

```
{
  "errorMessage": "Message: Service /opt/headless/chromedriver unexpectedly exited. Status code was: 127\n",
  "errorType": "WebDriverException",
  "requestId": "7dc3639c-9bff-4190-b4da-6e29f93ee16f",
  "stackTrace": [
    "  File \"/var/task/lambda_function.py\", line 18, in lambda_handler\n    browser = webdriver.Chrome(\n",
    "  File \"/opt/python/selenium/webdriver/chrome/webdriver.py\", line 45, in __init__\n    super().__init__(\n",
    "  File \"/opt/python/selenium/webdriver/chromium/webdriver.py\", line 55, in __init__\n    self.service.start()\n",
    "  File \"/opt/python/selenium/webdriver/common/service.py\", line 102, in start\n    self.assert_process_still_running()\n",
    "  File \"/opt/python/selenium/webdriver/common/service.py\", line 115, in assert_process_still_running\n    raise WebDriverException(f\"Service {self._path} unexpectedly exited. Status code was: {return_code}\")\n"
  ]
}
```

失敗した原因として、色々考えられそうなことはありますが、

* Windows環境でレイヤーのzipを作成したのが良くない？
* chromedriverとheadless-chromiumのバージョン組み合わせが良くない？
* もしくはPython3.10との組み合わせが良くない？

ここまで来るのに結構時間がかかったのもあって、正直考えるのが面倒になりました。よってこの方法は止めます。
</details>

### ではどうするか？

Dockerを使ってPythonアプリをコンテナ化することで、環境の一貫性を保つようにします。具体的には以下の手順で進めます。

1. Dockerfileを作成してビルド
2. Dockerイメージをビルド
3. アプリ修正
4. 動作確認

## 1. Dockerfileを作成

ポイントは以下の通りです。

* ECRにpushしてLambdaで使用することを想定してベースイメージを指定する
  * ECRの公開リポジトリにそれらしきものがありました。
  * https://gallery.ecr.aws/lambda/python
* 容量削減のために不要なライブラリは削除する

```Dockerfile:Dockerfile
FROM public.ecr.aws/lambda/python:3.10 AS build

# ChromeDriverのインストール
RUN yum install -y unzip && \
    curl -Lo "/tmp/chromedriver-linux64.zip" "https://storage.googleapis.com/chrome-for-testing-public/126.0.6478.126/linux64/chromedriver-linux64.zip" && \
    curl -Lo "/tmp/chrome-linux64.zip" "https://storage.googleapis.com/chrome-for-testing-public/126.0.6478.126/linux64/chrome-linux64.zip" && \
    unzip /tmp/chromedriver-linux64.zip -d /opt/ && \
    unzip /tmp/chrome-linux64.zip -d /opt/ && \
    yum remove -y unzip && \
    rm /tmp/chromedriver-linux64.zip && \
    rm /tmp/chrome-linux64.zip

# 必要なパッケージのインストール
FROM public.ecr.aws/lambda/python:3.10
RUN yum install -y atk cups-libs gtk3 libXcomposite alsa-lib \
    libXcursor libXdamage libXext libXi libXrandr libXScrnSaver \
    libXtst pango at-spi2-atk libXt xorg-x11-server-Xvfb \
    xorg-x11-xauth dbus-glib dbus-glib-devel nss mesa-libgbm \
    yum clean all && \
    rm -rf /var/cache/yum
COPY --from=build /opt/chrome-linux64 /opt/chrome
COPY --from=build /opt/chromedriver-linux64 /opt/

# Pythonモジュールを追加
COPY requirements.txt ${LAMBDA_TASK_ROOT}
RUN pip install -r requirements.txt
COPY config.json ${LAMBDA_TASK_ROOT}
COPY src/ ${LAMBDA_TASK_ROOT}/src/

CMD [ "src.main.handler" ]
```

## 2. Dockerイメージをビルド

この後でアプリ修正を行いますが、ローカルのファイル修正を即座にコンテナ内のファイルに反映できると便利です。そこで`docker-conpose.yml`を新規作成してビルドします。

```yml:docker-conpose.yml
services:
  lambda:
    build: .
    image: bank-auto-transfer
    container_name: bank-auto-transfer
    volumes:
      - .:/var/task
```

ターミナルで以下のコマンドを実行します。

```bash
docker compose up -d
```

実行後、以下のようになります。

```bash
$ docker container ls
CONTAINER ID   IMAGE                COMMAND                   CREATED          STATUS          PORTS     NAMES
b19572b63b5b   bank-auto-transfer   "/lambda-entrypoint.…"   10 minutes ago   Up 10 minutes             bank-auto-transfer
```

## 3. アプリ修正

コンテナ内ではブラウザを立ち上げないヘッドレスモードで動かす必要があります。そのためドライバー作成関数を切り分けることにしました。

```python:src/main.py
def create_driver_headless(config: Dict[str, Any]) -> WebDriver:
    # オプション設定
    options = webdriver.ChromeOptions()
    options.add_argument("--headless")
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-gpu")
    options.add_argument("--single-process")
    options.add_argument("--disable-dev-shm-usage")
    options.add_argument("--disable-dev-tools")
    options.add_argument("--user-agent=" + random.choice(config["ua_list"]))

    # Chromeドライバーのサービスを設定
    options.binary_location = "/opt/chrome/chrome"
    service = Service(executable_path="/opt/chromedriver")

    return webdriver.Chrome(service=service, options=options)


def create_driver_headfull(config: Dict[str, Any]) -> WebDriver:
    # オプション設定
    options = Options()
    options.add_argument("--user-agent=" + random.choice(config["ua_list"]))
    options.add_experimental_option("excludeSwitches", ["enable-logging"])

    # 最新バージョンのChromeドライバーを返却
    service = Service()

    return webdriver.Chrome(service=service, options=options)
```

さらに起動方法を以下のように切り分けます。

* ローカルのvenv環境で実行(ヘッドフルモード)
* Dockerコンテナ環境で実行(ヘッドレスモード)
* AWS Lambdaで実行(ヘッドレスモード)

```python:src/main.py
def handler(event, context):
    """Lambda関数ハンドラー"""
    config = load_config("config.json")
    driver = create_driver_headless(config["driver"])
    main(config, driver)


def execute_headfull():
    """ヘッドフルモード"""
    config = load_config("config.json")
    driver = create_driver_headfull(config["driver"])
    main(config, driver)


def execute_headless():
    """ヘッドレスモード"""
    config = load_config("config.json")
    driver = create_driver_headless(config["driver"])
    main(config, driver)


if __name__ == "__main__":
    load_dotenv()
    if os.getenv("LAMBDA_RUNTIME_DIR") is not None:
        execute_headless()
    else:
        execute_headfull()
```

## 4. 動作確認

元々作成していたヘッドフルモードでの確認と、新たに追加したヘッドレスモードでの確認を行います。`def handler(event, context)`の内容は実質的に`def execute_headless()`と同じなので省略することにします。

### ローカルのvenv環境で実行

exe.batを叩いて確認します。実行結果は以下の通りで、これまで通り動いていればOKです。

![銀行ポイ活自動化②_動作確認_ヘッドフルモード.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/a1e7d211-e3a6-21eb-ec07-5447c680ac8d.png)

### Dockerコンテナ環境で実行

ターミナルで以下のコマンドを実行します。

```bash
docker exec -it bank-auto-transfer python -m src.main
```

実行結果は以下の通りです。

![銀行ポイ活自動化②_動作確認_ヘッドレスモード.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1681290/56c22e17-0ecc-2256-0496-e35d32f0fde0.png)


## さいごに

Dockerイメージをビルドし、ヘッドレスモードの動作確認まで完了しました。次はAWS側の準備を進めます。手順は次の記事にて記載する予定です。
